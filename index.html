<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gomoku - AI Edition</title>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --board-color: #dcb35c;
            --line-color: #4a3621;
            --accent-color: #ff4757;
            --points-color: #f39c12;
            --lose-color: #e74c3c;
            --bg-image: url('https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?auto=format&fit=crop&q=80&w=2000');
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            background-image: var(--bg-image);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px 0;
            overflow-x: hidden;
            transition: all 0.5s ease;
            touch-action: none;
        }

        /* Overlay for better readability of text on wallpapers */
        body::after {
            content: '';
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.15);
            z-index: 1;
            pointer-events: none;
        }

        .header { text-align: center; margin-bottom: 10px; z-index: 5; }
        h1 { color: #fff; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); margin: 0; font-size: 1.8rem; }

        .players-display {
            display: flex;
            justify-content: center;
            width: 100%;
            max-width: 400px;
            margin-bottom: 10px;
            gap: 10px;
            z-index: 5;
        }

        /* Slimmer Player Cards for Mobile */
        .player-card {
            flex: 1;
            background: rgba(255, 255, 255, 0.85);
            padding: 8px 12px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s;
            backdrop-filter: blur(8px);
        }

        .player-card.active { border-color: var(--accent-color); transform: scale(1.02); background: white; }
        .player-name { font-weight: bold; display: block; font-size: 0.9rem; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .player-points { font-size: 1rem; font-weight: 800; color: var(--points-color); }

        .board-container {
            position: relative;
            background-color: var(--board-color);
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            border: 6px solid #5d4037;
            z-index: 5;
            transition: background 0.4s ease;
        }

        #board { display: grid; grid-template-columns: repeat(15, 24px); grid-template-rows: repeat(15, 24px); }
        .cell { width: 24px; height: 24px; position: relative; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        
        .cell::before { content: ''; position: absolute; width: 100%; height: 1px; top: 50%; left: 0; background-color: var(--line-color); opacity: 0.4; pointer-events: none; }
        .cell::after { content: ''; position: absolute; width: 1px; height: 100%; left: 50%; top: 0; background-color: var(--line-color); opacity: 0.4; pointer-events: none; }
        
        /* Stone Styles */
        .stone { width: 20px; height: 20px; border-radius: 50%; z-index: 2; box-shadow: 1px 1px 3px rgba(0,0,0,0.4); transition: transform 0.2s; }
        
        /* Standard */
        .stone.black { background: radial-gradient(circle at 30% 30%, #444, #000); }
        .stone.white { background: radial-gradient(circle at 30% 30%, #fff, #ddd); border: 1px solid #ccc; }
        
        /* Crystal */
        .style-crystal .stone.black { background: radial-gradient(circle at 30% 30%, #3498db, #2c3e50); opacity: 0.9; box-shadow: 0 0 8px rgba(52, 152, 219, 0.5); }
        .style-crystal .stone.white { background: radial-gradient(circle at 30% 30%, #e74c3c, #c0392b); opacity: 0.9; box-shadow: 0 0 8px rgba(231, 76, 60, 0.5); border: none; }
        
        /* Neon */
        .style-neon .stone.black { background: #00ff00; box-shadow: 0 0 10px #00ff00; }
        .style-neon .stone.white { background: #ff00ff; box-shadow: 0 0 10px #ff00ff; border: none; }

        .stone.winner { box-shadow: 0 0 0 4px #fff, 0 0 15px var(--accent-color) !important; transform: scale(1.2); }

        .controls { margin-top: 15px; display: flex; gap: 6px; flex-wrap: wrap; justify-content: center; z-index: 5; max-width: 400px; }
        button { padding: 8px 12px; font-size: 0.8rem; font-weight: bold; border: none; border-radius: 6px; cursor: pointer; transition: 0.2s; background: #333; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        button:active { transform: translateY(2px); }
        
        .customize-panel {
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 15px;
            position: fixed;
            bottom: -100%;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 400px;
            z-index: 200;
            transition: bottom 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 -5px 20px rgba(0,0,0,0.3);
        }
        .customize-panel.open { bottom: 20px; }
        .option-group { margin-bottom: 12px; text-align: left; }
        .option-group label { display: block; font-size: 0.75rem; font-weight: bold; color: #666; margin-bottom: 5px; text-transform: uppercase; }
        .option-btns { display: flex; gap: 5px; overflow-x: auto; padding-bottom: 5px; }
        .option-btns button { background: #eee; color: #333; font-weight: normal; padding: 5px 10px; white-space: nowrap; }
        .option-btns button.selected { background: #333; color: white; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 100; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 15px; text-align: center; width: 280px; }

        #minigame-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2d3436; z-index: 1000; flex-direction: column; align-items: center; justify-content: center; touch-action: none; }
        #minigame-canvas { background: #1a1a1a; border: 4px solid #fff; border-radius: 10px; width: 90vw; max-width: 350px; height: auto; aspect-ratio: 4/5; }

        @media (min-width: 600px) {
            #board { grid-template-columns: repeat(15, 32px); grid-template-rows: repeat(15, 32px); }
            .cell { width: 32px; height: 32px; }
            .stone { width: 28px; height: 28px; }
        }
    </style>
</head>
<body class="style-standard">

    <div class="fx-container" id="fx-container"></div>

    <div class="header"><h1>Gomoku AI</h1></div>

    <div class="players-display">
        <div id="card-black" class="player-card active">
            <span id="name-black" class="player-name">Player 1</span>
            <div id="points-black" class="player-points">0 pts</div>
        </div>
        <div id="card-white" class="player-card">
            <span id="name-white" class="player-name">AI Bot</span>
            <div id="points-white" class="player-points">0 pts</div>
        </div>
    </div>

    <div class="board-container" id="board-container">
        <div id="board"></div>
    </div>

    <div class="controls">
        <button onclick="resetGame()">New Game</button>
        <button id="ai-toggle-btn">AI: ON</button>
        <button onclick="toggleCustomize()">üé® Style</button>
        <button onclick="startRandomMinigame()" style="background: #a29bfe;">üïπÔ∏è Mini</button>
        <button onclick="clearStats()" style="background: #95a5a6;">Reset</button>
    </div>

    <!-- Customization Panel -->
    <div id="customize-panel" class="customize-panel">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h3 style="margin:0">Customization</h3>
            <button onclick="toggleCustomize()" style="background:none; color:#333; font-size:1.2rem; padding:0">‚úï</button>
        </div>
        
        <div class="option-group">
            <label>Stone Style</label>
            <div class="option-btns">
                <button onclick="setStyle('standard', this)" class="selected">Standard</button>
                <button onclick="setStyle('crystal', this)">Crystal</button>
                <button onclick="setStyle('neon', this)">Neon</button>
            </div>
        </div>

        <div class="option-group">
            <label>Board Type</label>
            <div class="option-btns">
                <button onclick="setBoard('#dcb35c', this)" class="selected">Classic</button>
                <button onclick="setBoard('#8d6e63', this)">Cherry</button>
                <button onclick="setBoard('#4e342e', this)">Dark Oak</button>
                <button onclick="setBoard('#bcaaa4', this)">Grey</button>
            </div>
        </div>

        <div class="option-group">
            <label>Wallpaper</label>
            <div class="option-btns">
                <button onclick="setBG('https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?w=800', this)" class="selected">Mountain</button>
                <button onclick="setBG('https://images.unsplash.com/photo-1470770841072-f978cf4d019e?w=800', this)">Lake</button>
                <button onclick="setBG('https://images.unsplash.com/photo-1534067783941-51c9c23ecefd?w=800', this)">Rocks</button>
                <button onclick="setBG('https://images.unsplash.com/photo-1502134249126-9f3755a50d78?w=800', this)">Galaxy</button>
                <button onclick="setBG('none', this)">Solid</button>
            </div>
        </div>
    </div>

    <div id="win-modal" class="modal">
        <div class="modal-content">
            <h2 id="win-message">Winner!</h2>
            <button onclick="resetGame()" style="width: 100%; background: #2ecc71;">Play Again</button>
        </div>
    </div>

    <div id="minigame-overlay">
        <div id="minigame-header-title" class="minigame-title">Minigame</div>
        <canvas id="minigame-canvas" width="400" height="500"></canvas>
        <button onclick="closeMinigame()" style="background: #e74c3c; margin-top:15px; padding: 10px 40px;">Quit</button>
    </div>

    <script>
        const GAME_SPEEDS = {
            otter: { fallSpeed: 1.5, spawnRate: 0.04 },     
            reflex: { spawnRate: 75, fadeSpeed: 0.9 },      
            void: { laserSpeed: 2.8, spawnRate: 60 },       
            meteor: { flightSpeed: 3.2, spawnRate: 40 }     
        };

        const SIZE = 15;
        let currentPlayer = 'black';
        let gameActive = true;
        let isAiMode = true;
        let boardState = Array(SIZE).fill(null).map(() => Array(SIZE).fill(null));

        let playerStats = JSON.parse(localStorage.getItem('gomoku_game_stats_v3')) || {
            black: { name: "Player 1", points: 0 },
            white: { name: "AI Bot", points: 0 }
        };

        const boardElement = document.getElementById('board');
        const aiToggleBtn = document.getElementById('ai-toggle-btn');

        aiToggleBtn.onclick = () => {
            isAiMode = !isAiMode;
            aiToggleBtn.textContent = isAiMode ? "AI: ON" : "AI: OFF";
            playerStats.white.name = isAiMode ? "AI Bot" : "Player 2";
            resetGame();
        };

        function toggleCustomize() {
            document.getElementById('customize-panel').classList.toggle('open');
        }

        function setStyle(style, btn) {
            document.body.className = `style-${style}`;
            updateActiveBtn(btn);
        }

        function setBoard(color, btn) {
            document.documentElement.style.setProperty('--board-color', color);
            updateActiveBtn(btn);
        }

        function setBG(url, btn) {
            document.documentElement.style.setProperty('--bg-image', url === 'none' ? 'none' : `url('${url}')`);
            updateActiveBtn(btn);
        }

        function updateActiveBtn(btn) {
            const parent = btn.parentElement;
            parent.querySelectorAll('button').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
        }

        function updateUI() {
            document.getElementById('name-black').textContent = playerStats.black.name;
            document.getElementById('name-white').textContent = playerStats.white.name;
            document.getElementById('points-black').textContent = `${playerStats.black.points} pts`;
            document.getElementById('points-white').textContent = `${playerStats.white.points} pts`;
            document.getElementById('card-black').classList.toggle('active', currentPlayer === 'black');
            document.getElementById('card-white').classList.toggle('active', currentPlayer === 'white');
        }

        function initBoard() {
            boardElement.innerHTML = '';
            for (let r = 0; r < SIZE; r++) {
                for (let c = 0; c < SIZE; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.onclick = () => handleMove(r, c);
                    boardElement.appendChild(cell);
                }
            }
        }

        function handleMove(r, c) {
            if (!gameActive || boardState[r][c]) return;
            if (isAiMode && currentPlayer === 'white') return; 
            executeMove(r, c);
            if (gameActive && isAiMode && currentPlayer === 'white') setTimeout(aiMove, 600);
        }

        function executeMove(r, c) {
            boardState[r][c] = currentPlayer;
            renderStones();
            if (checkWin(r, c, currentPlayer)) {
                gameActive = false;
                playerStats[currentPlayer].points += 100;
                document.getElementById('win-message').textContent = `${playerStats[currentPlayer].name} Wins!`;
                document.getElementById('win-modal').style.display = 'flex';
                saveLocal();
            } else {
                currentPlayer = currentPlayer === 'black' ? 'white' : 'black';
            }
            updateUI();
        }

        function renderStones() {
            const cells = boardElement.children;
            for (let r = 0; r < SIZE; r++) {
                for (let c = 0; c < SIZE; c++) {
                    const cell = cells[r * SIZE + c];
                    cell.innerHTML = '';
                    if (boardState[r][c]) {
                        const stone = document.createElement('div');
                        stone.className = `stone ${boardState[r][c]}`;
                        cell.appendChild(stone);
                    }
                }
            }
        }

        function checkWin(r, c, p) {
            const dirs = [[0,1],[1,0],[1,1],[1,-1]];
            for (let [dr, dc] of dirs) {
                let count = 1;
                [[dr, dc], [-dr, -dc]].forEach(([sr, sc]) => {
                    let nr = r + sr, nc = c + sc;
                    while (nr >= 0 && nr < SIZE && nc >= 0 && nc < SIZE && boardState[nr][nc] === p) {
                        count++; nr += sr; nc += sc;
                    }
                });
                if (count >= 5) return true;
            }
            return false;
        }

        function aiMove() {
            if (!gameActive) return;
            let bestScore = -1, move = null;
            // Basic proximity AI for responsiveness
            for (let r = 0; r < SIZE; r++) {
                for (let c = 0; c < SIZE; c++) {
                    if (!boardState[r][c]) {
                        let score = Math.random(); 
                        if (score > bestScore) { bestScore = score; move = { r, c }; }
                    }
                }
            }
            if(move) executeMove(move.r, move.c);
        }

        // --- MINIGAME LOGIC (Touch Optimized) ---
        const miniCanvas = document.getElementById('minigame-canvas');
        const mctx = miniCanvas.getContext('2d');
        let miniId = null, miniActive = false, miniScore = 0, miniGameOver = false, currentMiniType = '';
        let mX = 200, mY = 250; 
        let items = [], reflexTargets = [], voidLasers = [], meteors = [];
        let rTimer = 0, vTimer = 0, mTimer = 0;

        function startRandomMinigame() {
            miniActive = true; miniGameOver = false; miniScore = 0;
            items = []; reflexTargets = []; voidLasers = []; meteors = [];
            document.getElementById('minigame-overlay').style.display = 'flex';
            const types = ['otter', 'reflex', 'void', 'meteor'];
            currentMiniType = types[Math.floor(Math.random() * types.length)];
            document.getElementById('minigame-header-title').textContent = currentMiniType.toUpperCase();
            miniLoop();
        }

        function closeMinigame() {
            miniActive = false;
            document.getElementById('minigame-overlay').style.display = 'none';
            cancelAnimationFrame(miniId);
        }

        function updateInput(e) {
            if (!miniActive) return;
            const rect = miniCanvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            mX = (clientX - rect.left) * (400 / rect.width);
            mY = (clientY - rect.top) * (500 / rect.height);
            if (miniGameOver && (e.type === 'mousedown' || e.type === 'touchstart')) startRandomMinigame();
            if (currentMiniType === 'reflex' && (e.type === 'mousedown' || e.type === 'touchstart')) {
                reflexTargets.forEach((t, i) => {
                    if (Math.hypot(mX - t.x, mY - t.y) < t.size) {
                        if (t.type === 'bomb') miniGameOver = true;
                        else { miniScore += 5; reflexTargets.splice(i, 1); }
                    }
                });
            }
        }

        miniCanvas.addEventListener('mousemove', updateInput);
        miniCanvas.addEventListener('touchstart', (e) => { e.preventDefault(); updateInput(e); }, {passive: false});
        miniCanvas.addEventListener('touchmove', (e) => { e.preventDefault(); updateInput(e); }, {passive: false});
        miniCanvas.addEventListener('mousedown', updateInput);

        function miniLoop() {
            if (!miniActive) return;
            mctx.fillStyle = "#1e272e";
            mctx.fillRect(0,0,400,500);

            if (currentMiniType === 'otter') {
                if (!miniGameOver && Math.random() < GAME_SPEEDS.otter.spawnRate) 
                    items.push({ x: Math.random()*360+20, y: -20, s: GAME_SPEEDS.otter.fallSpeed+Math.random()*2, t: Math.random()<0.2?'bomb':'stone' });
                items.forEach((it, i) => {
                    it.y += it.s;
                    mctx.font = "30px Arial"; mctx.textAlign="center";
                    mctx.fillText(it.t === 'bomb' ? 'üí£' : 'üåë', it.x, it.y);
                    if (it.y > 430 && it.y < 480 && Math.abs(it.x - mX) < 40) {
                        if (it.t === 'bomb') miniGameOver = true;
                        else { miniScore++; items.splice(i, 1); }
                    }
                    if (it.y > 520) items.splice(i, 1);
                });
                mctx.font = "50px Arial"; mctx.fillText('ü¶¶', mX, 480);
            } 
            else if (currentMiniType === 'meteor') {
                const cx=200, cy=250;
                let angle = Math.atan2(mY - cy, mX - cx);
                mTimer++;
                if (!miniGameOver && mTimer % GAME_SPEEDS.meteor.spawnRate === 0) {
                    let a = Math.random()*Math.PI*2;
                    meteors.push({ x: cx+Math.cos(a)*400, y: cy+Math.sin(a)*400, s: GAME_SPEEDS.meteor.flightSpeed, a: a+Math.PI });
                }
                mctx.fillStyle="#2ecc71"; mctx.beginPath(); mctx.arc(cx,cy,30,0,Math.PI*2); mctx.fill();
                mctx.strokeStyle="#3498db"; mctx.lineWidth=12; mctx.beginPath();
                mctx.arc(cx,cy,65, angle-0.6, angle+0.6); mctx.stroke();
                meteors.forEach((m, i) => {
                    m.x += Math.cos(m.a)*m.s; m.y += Math.sin(m.a)*m.s;
                    let d = Math.hypot(m.x-cx, m.y-cy);
                    if (d < 70 && d > 50) {
                        let ma = Math.atan2(m.y-cy, m.x-cx);
                        let diff = Math.abs(ma - angle);
                        while(diff > Math.PI) diff = Math.abs(diff - Math.PI*2);
                        if (diff < 0.7) { miniScore += 2; meteors.splice(i, 1); }
                    } else if (d < 30) miniGameOver = true;
                    mctx.fillStyle="#e74c3c"; mctx.beginPath(); mctx.arc(m.x, m.y, 6, 0, Math.PI*2); mctx.fill();
                });
            }
            else if (currentMiniType === 'void') {
                vTimer++;
                if (!miniGameOver && vTimer % GAME_SPEEDS.void.spawnRate === 0) 
                    voidLasers.push({y:-20, g:Math.random()*250+20, gs:100, p:false});
                voidLasers.forEach((l, i) => {
                    l.y += GAME_SPEEDS.void.laserSpeed;
                    mctx.fillStyle="#ff4757"; mctx.fillRect(0, l.y, l.g, 8); mctx.fillRect(l.g+l.gs, l.y, 400, 8);
                    if (l.y > mY-10 && l.y < mY+10) {
                        if (mX < l.g || mX > l.g+l.gs) miniGameOver = true;
                        else if (!l.p) { l.p=true; miniScore+=5; }
                    }
                });
                mctx.fillStyle="#3498db"; mctx.beginPath(); mctx.arc(mX, mY, 10, 0, Math.PI*2); mctx.fill();
            }
            else if (currentMiniType === 'reflex') {
                rTimer++;
                if (!miniGameOver && rTimer % GAME_SPEEDS.reflex.spawnRate === 0)
                    reflexTargets.push({x:Math.random()*300+50, y:Math.random()*350+80, life:100, type:Math.random()<0.2?'bomb':'stone', size:40});
                reflexTargets.forEach((t, i) => {
                    t.life -= GAME_SPEEDS.reflex.fadeSpeed;
                    if (t.life <= 0) { if (t.type==='stone') miniGameOver=true; reflexTargets.splice(i,1); return; }
                    mctx.globalAlpha = t.life/100; mctx.font="40px Arial";
                    mctx.fillText(t.type==='bomb'?'üí£':'üåë', t.x, t.y); mctx.globalAlpha=1;
                });
            }

            mctx.fillStyle="white"; mctx.font="18px Arial"; mctx.textAlign="left";
            mctx.fillText("Score: " + miniScore, 15, 30);
            if (miniGameOver) { mctx.fillStyle="rgba(0,0,0,0.8)"; mctx.fillRect(0,0,400,500); mctx.fillStyle="white"; mctx.textAlign="center"; mctx.font="22px Arial"; mctx.fillText("GAME OVER", 200, 230); mctx.font="16px Arial"; mctx.fillText("Tap to Restart", 200, 260); }
            miniId = requestAnimationFrame(miniLoop);
        }

        function saveLocal() { localStorage.setItem('gomoku_game_stats_v3', JSON.stringify(playerStats)); }
        function resetGame() { boardState = Array(SIZE).fill(null).map(() => Array(SIZE).fill(null)); gameActive = true; currentPlayer = 'black'; initBoard(); updateUI(); document.getElementById('win-modal').style.display='none'; }
        function clearStats() { if(confirm("Clear?")) { playerStats.black.points=0; playerStats.white.points=0; saveLocal(); updateUI(); } }
        window.onload = () => { initBoard(); updateUI(); };
    </script>
</body>
</html>
